<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Introducing Transient Replication | Blog</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<link rel="stylesheet" href="/style.css">
		<script src="/init.js"></script>
		
		<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,400&family=Red+Hat+Display:ital,wght@0,400;0,500;0,700;1,400;1,500&display=swap" rel="stylesheet">
	
			
	
<script async defer data-domain="cassandra.apache.org" src="https://plausible.cassandra.apache.org/js/plausible.js"></script></head>
	<body class="blog-index">
		<div class="container mx-auto">
			<div id="mobile-nav-overlay" class="hide">
				<div class="mobile-nav flex flex-column text-center">
					<a class="mobile-nav-link" href="/cassandra-basics/">Cassandra Basics</a>
					<a class="mobile-nav-link" href="/quickstart/">Quickstart</a>
					<a class="mobile-nav-link" href="/ecosystem/">Ecosystem</a>
					<a class="mobile-nav-link" href="https://cassandra.apache.org/doc/latest/">Documentation</a>
					<a class="mobile-nav-link" href="/community/">Community</a>
					<a class="mobile-nav-link" href="/case-studies/">Case Studies</a>
					<a class="mobile-nav-link" href="/resources/">Resources</a>
					<a class="mobile-nav-link" href="/blog/">Blog</a>
					<a class="mobile-nav-link" href="/download/">Download</a>
				</div>
			</div>
			<header class="grad">
				<div class="eye"></div>
				<div id="top-nav" class="inner flex flex-vert-center flex-space-between relative">
					<div class="logo"><a href="/"><img src="/img/logo-white.svg" alt=""></a></div>
					<div class="mobile-nav-icon">
						<img class="toggle-icon" src="/img/hamburger-nav.svg">
					</div>
					
					<ul class="nav-links flex flex-vert-center flex-space-between">
						<li>
							<a class="nav-link">Get Started</a>
							<ul class="sub-menu bg-white">
								<li class="pa-micro">
									<a href="/cassandra-basics/">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-basics.png" alt="cassandra basics icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Cassandra Basics
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/quickstart/">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-rocket.png" alt="cassandra basics icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Quickstart
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/ecosystem/">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-ecosystem.png" alt="cassandra basics icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Ecosystem
										</div>
									</a>
								</li>
							</ul>
						</li>
						<li><a class="nav-link" href="https://cassandra.apache.org/doc/latest/">Documentation</a></li>
						<li>
							<a class="nav-link" href="/community/">Community</a>
							<ul class="sub-menu bg-white">
								<li class="pa-micro">
									<a href="/community/#code-of-conduct">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-welcome.png" alt="welcome icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Welcome
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/community/#discussion">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-discussions.png" alt="discussions icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Discussions
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/community/#project-governance">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-governance.png" alt="Governance icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Governance
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/community/#how-to-contribute">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-contribute.png" alt="Contribute icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Contribute
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/community/#meet-the-community">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-community.png" alt="Meet the Community icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Meet the Community
										</div>
									</a>
								</li>
							</ul>
						</li>
						<li>
							<a class="nav-link">Learn</a>
							<ul class="sub-menu bg-white">
								<li class="pa-micro">
									<a href="/case-studies/">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-case-study.png" alt="Case Studies icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Case Studies
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/resources/">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-resources.png" alt="Resources icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Resources
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/blog/">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-blog.png" alt="Blog icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Blog
										</div>
									</a>
								</li>
							</ul>
						</li>
						<li><a class="nav-link btn btn--filled" href="/download/">Download Now</a></li>
					</ul>
					
				</div>
				<div class="text-center flex flex-center flex-column relative z2 ma-xlarge">
					<h1 class="ma-large">
                        Introducing Transient Replication
                    </h1>
					<h3> December 03, 2018  | The Apache Cassandra Community</h3> 
				</div>
			</header>
			<section id="blog-post" class="arrow py-xlarge">
				<div class="inner">
                    <h5><a href="/blog">« Back to the Apache Cassandra Blog</a></h5>
                    <hr>
                    <p>Transient Replication is a new experimental feature soon to be available in 4.0. When enabled, it allows for the creation of keyspaces where replication factor can be specified as a number of copies (full replicas) and temporary copies (transient replicas). Transient replicas retain the data they replicate only long enough for it to be propagated to full replicas, via incremental repair, at which point the data is deleted. Writing to transient replicas can be avoided almost entirely if monotonic reads are not required because it is possible to achieve a quorum of acknowledged writes without them.</p>
                  
                  <p>This results in a savings in disk space, CPU, and IO. By deleting data as soon as it is no longer needed, transient replicas require only a fraction of the disk space of a full replica. By not having to store the data indefinitely, the CPU and IO required for compaction is reduced, and read queries are faster as they have less data to process.</p>
                  
                  <p>So what are the benefits of not actually keeping a full copy of the data? Well, for some installations and use cases, transient replicas can be almost free if <a target="_blank" href="https://en.wikipedia.org/wiki/Consistency_model#Monotonic_Read_Consistency">monotonic reads</a> are disabled. In future releases where monotonic reads are supported with Transient Replication, enabling monotonic reads would reduce the savings in CPU and IO, but even then they should still be significant.</p>
                  
                  <p>Transient Replication is designed to be transparent to applications:</p>
                  
                  <ul>
                    <li>Consistency levels continue to produce the same results for queries.</li>
                    <li>The number of replicas that can be lost before data loss occurs is unchanged.</li>
                    <li>The number of replicas that can be unavailable before some queries start to timeout or return unavailable is unchanged (with the exception of ONE).</li>
                  </ul>
                  
                  <p>With Transient Replication, you can go from 3 replicas to 5 replicas, two of which are transient, without adding any hardware.</p>
                  
                  <p>If you are running an active-passive 2 DC setup with 3 replicas in each DC, you can make one replica in each DC transient and still have four full copies of the data in total.</p>
                  
                  <h2 id="feature-support">Feature support</h2>
                  
                  <p>Transient Replication is not intended to fully replace Cassandra’s existing approach to replication. There are features that currently don’t work with transiently replicated keyspaces and features that are unlikely ever to work with them.</p>
                  
                  <p>You can have keyspaces with and without Transient Replication enabled in the same cluster, so it is possible to use Transient Replication for just the use cases that are a good fit for the currently available functionality.</p>
                  
                  <h3 id="currently-unsupported-but-coming">Currently unsupported but coming:</h3>
                  
                  <ul>
                    <li>Monotonic reads</li>
                    <li>Batch log</li>
                    <li>LWT</li>
                    <li>Counters</li>
                  </ul>
                  
                  <h3 id="will-never-be-supported">Will never be supported:</h3>
                  
                  <ul>
                    <li>Secondary indexes</li>
                    <li>Materialized views</li>
                  </ul>
                  
                  <h2 id="how-transient-replication-works">How Transient Replication works</h2>
                  
                  <h3 id="overview">Overview</h3>
                  
                  <p>Transient replication extends Cassandra’s existing consistent hashing algorithm to designate some replicas of a point or range on the consistent hash ring as transient and some as full. The following image depicts a consistent hash ring with three replicas <strong>A</strong>, <strong>B</strong>, and <strong>C</strong>. The replicas are located at tokens 5, 10, 15 respectively. A key <strong><em>k</em></strong> hashes to token 3 on the ring.</p>
                  
                  <p><img src="../img/blog/diagram-hash-ring.gif" alt="A consistent hash ring without Transient Replication" title="A consistent hash ring without Rransient Replication"></p>
                  
                  <p>Replicas are selected by walking the ring clockwise starting at the point on the ring the key hashes to. At RF=3, the replicas of key <strong><em>k **</em>are **A</strong>, <strong>B</strong>, <strong>C</strong>.
                  With Transient Replication, the last N replicas (where N is the configured number of transient replicas) found while walking the ring are designated as transient.</p>
                  
                  <p>There are no nodes designated as transient replicas or full replicas. All nodes will fully replicate some ranges on the ring and transiently replicate others.</p>
                  
                  <p>The following image depicts a consistent hash ring at RF=3/1 (three replicas, one of which is transient). The replicas of <strong><em>k</em></strong> are still <strong>A</strong>, <strong>B</strong>, and <strong>C</strong>, but <strong>C</strong> is now transiently replicating <strong><em>k</em></strong>.</p>
                  
                  <p><img src="../img/blog/diagram-hash-ring-with-transient-replica.gif" alt="A consistent hash ring with Transient Replication" title="A consistent hash ring with Transient Replication"></p>
                  
                  <p>Normally all replicas of a range receive all writes for that range, as depicted in the following image.</p>
                  
                  <p><img src="../img/blog/diagram-regular-write.gif" alt="Normal write behavior" title="Normal write behavior"></p>
                  
                  <p>Transient replicas do not receive writes in the normal write path.</p>
                  
                  <p><img src="../img/blog/diagram-transient-write.gif" alt="Transient write behavior" title="Transient write behavior"></p>
                  
                  <p>If sufficient full replicas are unavailable, transient replicas will receive writes.</p>
                  
                  <p><img src="../img/blog/diagram-transient-write-down-node.gif" alt="Transient write with unavailable node" title="Transient write with unavailable node"></p>
                  
                  <p>This optimization, which is possible with Transient Replication, is called Cheap Quorums. This minimizes the amount of work that transient replicas have to do at write time, and reduces the amount of background compaction they will have to do.</p>
                  
                  <p><strong>Cheap Quorums and monotonic reads:</strong> Cheap Quorums may end up being incompatible with an initial implementation of monotonic reads, and operators will be able to make a conscious trade off between performance and monotonic reads.</p>
                  
                  <h3 id="rapid-write-protection">Rapid write protection</h3>
                  
                  <p>In keyspaces utilizing Transient Replication, writes are sent to every full replica and enough transient replicas to meet the requested consistency level (to make up for unavailable full replicas). In addition, enough transient replicas are selected to reach a quorum in every datacenter, though unless the consistency level requires it, the write will be acknowledged without ensuring all have been delivered.</p>
                  
                  <p>Because not all replicas are sent the write, it’s possible that insufficient replicas will respond, causing timeouts.  To prevent this, we implement rapid write protection, similar to rapid read protection, that sends writes to additional replicas if sufficient acknowledgements to meet the consistency level are not received promptly.</p>
                  
                  <p>The following animation shows rapid write protection in action.</p>
                  
                  <p><img src="../img/blog/diagram-rapid-write-protection.gif" alt="Animation of rapid write protection preventing a write timeout" title="Rapid write protection preventing a write timeout"></p>
                  
                  <p>Rapid write protection is configured similarly to rapid read protection using the table option <code class="highlighter-rouge">additional_write_policy</code>. The policy determines how long to wait for acknowledgements before sending additional mutations. The default is to wait for P99 of the observed latency.</p>
                  
                  <h3 id="incremental-repair">Incremental repair</h3>
                  
                  <p>Incremental repair is used to clean up transient data at transient replicas and propagate it to full replicas.</p>
                  
                  <p>When incremental repair occurs transient replicas stream out transient data, but don’t receive any. Anti-compaction is used to separate transient and fully replicated data so that only fully replicated data is retained once incremental repair completes.</p>
                  
                  <p>The result of running an incremental repair is that all full replicas for a range are synchronized and can be used interchangeably to retrieve the repaired data set for a query.</p>
                  
                  <h3 id="read-path">Read path</h3>
                  
                  <p>Reads must always include at least one full replica and can include as many replicas (transient or full) as necessary to achieve the desired consistency level. At least one full replica is required in order to provide the data not available at transient replicas, but it doesn’t matter which full replica is picked because incremental repair synchronizes the repaired data set across full replicas.</p>
                  
                  <p>Reads at transient replicas are faster than reads at full replicas because reads at transient replicas are unlikely to return any results if monotonic reads are disabled, and they haven’t been receiving writes.</p>
                  
                  <h2 id="creating-keyspaces-with-transient-replication">Creating keyspaces with Transient Replication</h2>
                  
                  <p>Transient Replication is supported by SimpleStrategy and NetworkTopologyStrategy. When specifying the replication factor, you can specify the number of transient replicas in addition to the total number of replicas (including transient replicas). The syntax for a replication factor of 3 replicas total with one of them being transient would be “3/1”.</p>
                  
                  <div class="highlighter-rouge"><pre class="highlight"><code>ALTER KEYSPACE foo WITH REPLICATION = {'class' : 'NetworkTopologyStrategy', 'DC1' : '3/1'};
                  ALTER KEYSPACE foo WITH REPLICATION = {'class' : 'SimpleStrategy', 'replication_factor' : '3/1'};
                  </code></pre>
                  </div>
                  
                  <p>Monotonic reads are not supported with Transient Replication in 4.0, so any existing tables in the keyspace must have monotonic reads disabled by setting <code class="highlighter-rouge">read_repair = 'NONE'</code></p>
                  
                  <p>Once the keyspace has been altered, you will need to run incremental repair and then nodetool cleanup to ensure  transient data is cleaned up.</p>
                  
                  <h2 id="operational-matters">Operational matters</h2>
                  
                  <p>Transient replication requires rolling incremental repair to be run regularly in order to move data from transient replicas to full replicas. By default transient replicas will receive 1% of writes for transiently replicated ranges due to rapid write protection. If a node is down for an extended period of time, its transient replicas will receive additional write load and that data should be cleaned up using incremental repair. Running incremental repair regularly will ensure that the size of each repair is small.</p>
                  
                  <p>It’s also a good idea to run a small number of vnodes with transient replication so that when a node goes down the load is spread out over several other nodes that transiently replicate that range. Larges numbers of vnodes are known to be problematic, so it’s best to start with a cluster that is already close to or at its maximum size so that a small number of vnodes will be sufficient. If you intend to grow the cluster in the future, you will need to be cognizant of how this will interact with the number of vnodes you select.</p>
                  
                  <p>While the odds of any data loss should multiple nodes be permanently lost remain the same with transient replication, the magnitude of potential data loss does not. With 3/1 transient replication the permanent loss of two nodes could result in the loss of the entirety of the repaired data set. If you are running a multi-DC setup with a high level of replication such as 2 DCs, with 3/1 replicas in each, then you will have 4 full copies total and the added risk of transient replication is minimal.</p>
                  
                  <h2 id="experimental-features">Experimental features</h2>
                  
                  <p>Experimental features are a relatively new idea for Apache Cassandra. Although we recently voted to make materialized views an experimental feature retroactively, Transient Replication is the first experimental feature to be introduced as such.</p>
                  
                  <p>The goal of introducing experimental features is to allow for incremental development across multiple releases. In the case of Transient Replication, we can avoid a giant code drop that heavily modifies the code base, and the associated risks with incorporating a new feature that way.</p>
                  
                  <p>What it means for a feature to be experimental doesn’t have a set definition, but for Transient Replication it’s intended to set expectations. As of 4.0, Transient Replication’s intended audience is expert operators of Cassandra with the ability to write the book on how to safely deploy Transient Replication, debug any issues that result, and if necessary contribute code back to address problems as they are discovered.</p>
                  
                  <p>It’s expected that the feature set for Transient Replication will not change in minor updates to 4.0, but eventually it should be ready for use by a wider audience.</p>
                  
                  <h2 id="next-steps-for-transient-replication">Next steps for Transient Replication</h2>
                  
                  <p>If increasing availability or saving on capacity sounds good to you, then you can help make transient replication production-ready by testing it out or even deploying it. Experience and feedback from the community is one the of the things that will drive transient replication bug fixing and development.</p>
                  
				</div>
			</section>
			<footer class="grad grad--two flex-center pb-xlarge">
				<div class="inner text-center z2 relative">
					<h2 class="white py-small">Get started with Cassandra, fast.</h2>
					<a href="/quickstart/" class="btn btn--filled ma-medium">Quickstart Guide</a>
				</div>
				<div class="inner flex flex-distribute-items mt-xlarge z2 relative">
					<div class="col-2">
						<div class="logo mb-medium"><img src="/img/logo-white.svg" alt=""></div>
						<p>Apache Cassandra powers mission-critical deployments with improved performance and unparalleled levels of scale in the cloud.</p>
					</div>
					<div class="col-2 flex flex-center">
						<ul class="columns-2">
							<li class="mb-small"><a href="/">Home</a></li>
							<li class="mb-small"><a href="/cassandra-basics/">Cassandra Basics</a></li>
							<li class="mb-small"><a href="/quickstart/">Quickstart</a></li>
							<li class="mb-small"><a href="/ecosystem/">Ecosystem</a></li>
							<li class="mb-small"><a href="https://cassandra.apache.org/doc/latest/">Documentation</a></li>
							<li class="mb-small"><a href="/community/">Community</a></li>
							<li class="mb-small"><a href="/case-studies/">Case Studies</a></li>
							<li class="mb-small"><a href="/resources/">Resources</a></li>
							<li class="mb-small"><a href="/blog/">Blog</a></li>
							
						</ul>
					</div>
				</div>
			</footer>
			<div class="lower-footer bg-white pa-medium">
				<div class="flex flex-row flex-vert-center">
					<div class="pr-medium"><img src="../img/feather-small.png" alt="ASF" width="20"></div>
					<div class="pr-medium"><a href="http://www.apache.org/" target="_blank">Foundation</a></div>
					<div class="pr-medium"><a href="https://www.apache.org/events/current-event.html" target="_blank">Events</a></div>
					<div class="pr-medium"><a href="https://www.apache.org/licenses/" target="_blank">License</a></div>
					<div class="pr-medium"><a href="https://www.apache.org/foundation/thanks" target="_blank">Thanks</a></div>
					<div class="pr-medium"><a href="https://www.apache.org/security" target="_blank">Security</a></div>
					<div class="pr-medium"><a href="https://www.apache.org/foundation/sponsorship" target="_blank">Sponsorship</a></div>
				</div>
				<p class="my-medium">&copy; <script>document.write(new Date().getFullYear())</script> <a href="https://apache.org" target="_blank">The Apache Software Foundation</a> under the terms of the Apache License 2.0. Apache, the Apache feather logo, and Apache Cassandra are trademarks of The Apache Software Foundation.</p>
			</div>
		</div>
                <div id="fade" class="hidden"></div>
			<div id="modal" class="modal hidden">
				<div id="close-modal" class="cursor-pointer"><svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
				<div id="mod-content" class="vid-mod-content resp-container">
			</div>
		</div>
	</body>
</html>