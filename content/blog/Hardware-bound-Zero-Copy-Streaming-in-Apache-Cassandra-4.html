<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Hardware-bound Zero Copy Streaming in Apache Cassandra 4.0 | Blog</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
		<link rel="stylesheet" href="/style.css">
		<script src="/init.js"></script>
		
		<link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,400&family=Red+Hat+Display:ital,wght@0,400;0,500;0,700;1,400;1,500&display=swap" rel="stylesheet">
	
			
	
<script async defer data-domain="cassandra.apache.org" src="https://plausible.cassandra.apache.org/js/plausible.js"></script></head>
	<body class="blog-index">
		<div class="container mx-auto">
			<div id="mobile-nav-overlay" class="hide">
				<div class="mobile-nav flex flex-column text-center">
					<a class="mobile-nav-link" href="/cassandra-basics/">Cassandra Basics</a>
					<a class="mobile-nav-link" href="/quickstart/">Quickstart</a>
					<a class="mobile-nav-link" href="/ecosystem/">Ecosystem</a>
					<a class="mobile-nav-link" href="https://cassandra.apache.org/doc/latest/">Documentation</a>
					<a class="mobile-nav-link" href="/community/">Community</a>
					<a class="mobile-nav-link" href="/case-studies/">Case Studies</a>
					<a class="mobile-nav-link" href="/resources/">Resources</a>
					<a class="mobile-nav-link" href="/blog/">Blog</a>
					<a class="mobile-nav-link" href="/download/">Download</a>
				</div>
			</div>
			<header class="grad">
				<div class="eye"></div>
				<div id="top-nav" class="inner flex flex-vert-center flex-space-between relative">
					<div class="logo"><a href="/"><img src="/img/logo-white.svg" alt=""></a></div>
					<div class="mobile-nav-icon">
						<img class="toggle-icon" src="/img/hamburger-nav.svg">
					</div>
					
					<ul class="nav-links flex flex-vert-center flex-space-between">
						<li>
							<a class="nav-link">Get Started</a>
							<ul class="sub-menu bg-white">
								<li class="pa-micro">
									<a href="/cassandra-basics/">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-basics.png" alt="cassandra basics icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Cassandra Basics
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/quickstart/">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-rocket.png" alt="cassandra basics icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Quickstart
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/ecosystem/">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-ecosystem.png" alt="cassandra basics icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Ecosystem
										</div>
									</a>
								</li>
							</ul>
						</li>
						<li><a class="nav-link" href="https://cassandra.apache.org/doc/latest/">Documentation</a></li>
						<li>
							<a class="nav-link" href="/community/">Community</a>
							<ul class="sub-menu bg-white">
								<li class="pa-micro">
									<a href="/community/#code-of-conduct">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-welcome.png" alt="welcome icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Welcome
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/community/#discussion">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-discussions.png" alt="discussions icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Discussions
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/community/#project-governance">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-governance.png" alt="Governance icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Governance
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/community/#how-to-contribute">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-contribute.png" alt="Contribute icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Contribute
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/community/#meet-the-community">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-community.png" alt="Meet the Community icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Meet the Community
										</div>
									</a>
								</li>
							</ul>
						</li>
						<li>
							<a class="nav-link">Learn</a>
							<ul class="sub-menu bg-white">
								<li class="pa-micro">
									<a href="/case-studies/">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-case-study.png" alt="Case Studies icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Case Studies
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/resources/">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-resources.png" alt="Resources icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Resources
										</div>
									</a>
								</li>
								<li class="pa-micro">
									<a href="/blog/">
										<div class="sub-nav-icon">
											<img src="/img/sub-menu-blog.png" alt="Blog icon">
										</div>
										<div class="sub-nav-text teal py-small">
											Blog
										</div>
									</a>
								</li>
							</ul>
						</li>
						<li><a class="nav-link btn btn--filled" href="/download/">Download Now</a></li>
					</ul>
					
				</div>
				<div class="text-center flex flex-center flex-column relative z2 ma-xlarge">
					<h1 class="ma-large">Hardware-bound Zero Copy Streaming in Apache Cassandra 4.0
                    </h1>
					<h3> August 07, 2018 | The Apache Cassandra Community</h3> 
				</div>
			</header>
			<section id="blog-post" class="arrow py-xlarge">
				<div class="inner">
                    <h5><a href="/blog">« Back to the Apache Cassandra Blog</a></h5>
					<hr>
					<p>Streaming in Apache Cassandra powers host replacement, range movements, and cluster expansions. Streaming plays a crucial role in the cluster and as such its performance is key to not only the speed of the operations its used in but the cluster’s health generally. In Apache Cassandra 4.0, we have introduced an improved streaming implementation that reduces GC pressure and increases throughput several folds and are now limited, in some cases, only by the disk / network IO (See: <a target="_blank" href="https://issues.apache.org/jira/browse/CASSANDRA-14556">CASSANDRA-14556</a>).</p>

					<p><img src="../img/blog/hardware-bound-1.png" alt="Fig 1. Cassandra Streaming" style="float: right;margin-right: 7px;margin-top: 7px;"> To get an understanding of the impact of these changes, let’s first have a look at the current streaming code path. The diagram below illustrates the stream session setup when a node attempts to stream data from a peer. Let’s say, we have a 3 node cluster (Nodes A, B, C). Node C is being rebuilt and has to stream all data that it is responsible for from A &amp; B. C setups a streaming session with each of it’s peers (See: <a target="_blank" href="https://issues.apache.org/jira/browse/CASSANDRA-4650">CASSANDRA-4560</a> how Cassandra applies <a target="_blank" href="https://en.wikipedia.org/wiki/Ford%E2%80%93Fulkerson_algorithm">Ford Fulkerson</a> to optimize streaming peers). It exchanges messages to request ranges and begins streaming data from the selected nodes.</p>

					<p>During the streaming phase, A collects all SSTables that have partitions in the requested ranges. It streams each SSTable by serializing individual partitions. Upon receiving the partition, node C reifies the data in memory and then writes it to disk. This is necessary to accurately transfer partitions from all possible SSTables for the requested ranges. This streaming path generates garbage and could be avoided in scenarios where all partitions within the SSTable need to be transmitted. This is common when you’re using LeveledCompactionStrategy or have enabled partitioning SSTables by token range (See: <a target="_blank" href="http://issues.apache.org/jira/browse/CASSANDRA-6696">CASSANDRA-6696</a>), etc.</p>

					<p>To solve this problem <a target="_blank" href="http://issues.apache.org/jira/browse/CASSANDRA-14556">CASSANDRA-14556</a> adds a Zero Copy streaming path. This significantly speeds up the transfer of SSTables and reduces garbage and unnecessary object creation. It modifies the streaming path to add additional information into the streaming header and uses ZeroCopy APIs to transfer bytes to and from the network and disk. So now, an SSTable may be transferred using this strategy when Cassandra detects that a complete SSTable needs to be transferred.</p>

					<h2 id="how-do-i-use-this-feature">How do I use this feature?</h2>

					<p>It just works. This feature is controlled using <code class="highlighter-rouge">stream_entire_sstables</code> in <code class="highlighter-rouge">cassandra.yaml</code> and is enabled by default. Even though this feature is enabled, it will respect the throttling limits as defined by <code class="highlighter-rouge">stream_throughput_outbound_megabits_per_sec</code>.</p>

					<h2 id="impact">Impact</h2>

					<p>Cassandra can stream SSTables only bounded by the hardware limitations (Network and Disk IO). With this optimization, we hope to make Cassandra more performant and reliable.</p>

					<p>Microbenchmarking this feature shows a marked improvement (higher is better). Block Stream Writers are the ZeroCopy writers and Partial Stream Writers are the existing writers.</p>

					<div class="stat-table">
						<table>
					<thead>
					<tr>
					<th style="border: 1px solid #ddd; padding: 5px;">Benchmark</th>
					<th style="border: 1px solid #ddd; padding: 5px;">Mode</th>
					<th style="border: 1px solid #ddd; padding: 5px;">Cnt</th>
					<th style="border: 1px solid #ddd; padding: 5px;">Score</th>
					<th style="border: 1px solid #ddd; padding: 5px;">Error</th>
					<th style="border: 1px solid #ddd; padding: 5px;">Units</th>
					</tr>
					</thead>
					<tbody>
					<tr>
					<td style="border: 1px solid #ddd; padding: 5px;">ZeroCopyStreamingBenchmark.blockStreamReader</td>
					<td style="border: 1px solid #ddd; padding: 5px;">thrpt</td>
					<td style="border: 1px solid #ddd; padding: 5px;">10</td>
					<td style="border: 1px solid #ddd; padding: 5px;">20.119</td>
					<td style="border: 1px solid #ddd; padding: 5px;">± 1.300</td>
					<td style="border: 1px solid #ddd; padding: 5px;">ops/s</td>
					</tr>
					<tr>
					<td style="border: 1px solid #ddd; padding: 5px;">ZeroCopyStreamingBenchmark.blockStreamWriter</td>
					<td style="border: 1px solid #ddd; padding: 5px;">thrpt</td>
					<td style="border: 1px solid #ddd; padding: 5px;">10</td>
					<td style="border: 1px solid #ddd; padding: 5px;">1339.672</td>
					<td style="border: 1px solid #ddd; padding: 5px;">± 352.242</td>
					<td style="border: 1px solid #ddd; padding: 5px;">ops/s</td>
					</tr>
					<tr>
					<td style="border: 1px solid #ddd; padding: 5px;">ZeroCopyStreamingBenchmark.partialStreamReader</td>
					<td style="border: 1px solid #ddd; padding: 5px;">thrpt</td>
					<td style="border: 1px solid #ddd; padding: 5px;">10</td>
					<td style="border: 1px solid #ddd; padding: 5px;">0.590</td>
					<td style="border: 1px solid #ddd; padding: 5px;">± 0.135</td>
					<td style="border: 1px solid #ddd; padding: 5px;">ops/s</td>
					</tr>
					<tr>
					<td style="border: 1px solid #ddd; padding: 5px;">ZeroCopyStreamingBenchmark.partialStreamWriter</td>
					<td style="border: 1px solid #ddd; padding: 5px;">thrpt</td>
					<td style="border: 1px solid #ddd; padding: 5px;">10</td>
					<td style="border: 1px solid #ddd; padding: 5px;">17.556</td>
					<td style="border: 1px solid #ddd; padding: 5px;">± 0.323</td>
					<td style="border: 1px solid #ddd; padding: 5px;">ops/s</td>
					</tr>
					</tbody>
					</table></div>

					

					<h2 id="conclusion">Conclusion</h2>

					<p>If you’re a Cassandra user, we would love to hear back from you. Please send us feedback via user <a href="http://cassandra.apache.org/community/">Mailing List</a>, <a target="_blank" href="https://issues.apache.org/jira/projects/CASSANDRA/summary">Jira</a>, or <a href="http://cassandra.apache.org/community/">IRC</a> (or any combination of the three).</p>


				</div>
			</section>
			<footer class="grad grad--two flex-center pb-xlarge">
				<div class="inner text-center z2 relative">
					<h2 class="white py-small">Get started with Cassandra, fast.</h2>
					<a href="/quickstart/" class="btn btn--filled ma-medium">Quickstart Guide</a>
				</div>
				<div class="inner flex flex-distribute-items mt-xlarge z2 relative">
					<div class="col-2">
						<div class="logo mb-medium"><img src="/img/logo-white.svg" alt=""></div>
						<p>Apache Cassandra powers mission-critical deployments with improved performance and unparalleled levels of scale in the cloud.</p>
					</div>
					<div class="col-2 flex flex-center">
						<ul class="columns-2">
							<li class="mb-small"><a href="/">Home</a></li>
							<li class="mb-small"><a href="/cassandra-basics/">Cassandra Basics</a></li>
							<li class="mb-small"><a href="/quickstart/">Quickstart</a></li>
							<li class="mb-small"><a href="/ecosystem/">Ecosystem</a></li>
							<li class="mb-small"><a href="https://cassandra.apache.org/doc/latest/">Documentation</a></li>
							<li class="mb-small"><a href="/community/">Community</a></li>
							<li class="mb-small"><a href="/case-studies/">Case Studies</a></li>
							<li class="mb-small"><a href="/resources/">Resources</a></li>
							<li class="mb-small"><a href="/blog/">Blog</a></li>
							
						</ul>
					</div>
				</div>
			</footer>
			<div class="lower-footer bg-white pa-medium">
				<div class="flex flex-row flex-vert-center">
					<div class="pr-medium"><img src="../img/feather-small.png" alt="ASF" width="20"></div>
					<div class="pr-medium"><a href="http://www.apache.org/" target="_blank">Foundation</a></div>
					<div class="pr-medium"><a href="https://www.apache.org/events/current-event.html" target="_blank">Events</a></div>
					<div class="pr-medium"><a href="https://www.apache.org/licenses/" target="_blank">License</a></div>
					<div class="pr-medium"><a href="https://www.apache.org/foundation/thanks" target="_blank">Thanks</a></div>
					<div class="pr-medium"><a href="https://www.apache.org/security" target="_blank">Security</a></div>
					<div class="pr-medium"><a href="https://www.apache.org/foundation/sponsorship" target="_blank">Sponsorship</a></div>
				</div>
				<p class="my-medium">&copy; <script>document.write(new Date().getFullYear())</script> <a href="https://apache.org" target="_blank">The Apache Software Foundation</a> under the terms of the Apache License 2.0. Apache, the Apache feather logo, and Apache Cassandra are trademarks of The Apache Software Foundation.</p>
			</div>
		</div>
                <div id="fade" class="hidden"></div>
			<div id="modal" class="modal hidden">
				<div id="close-modal" class="cursor-pointer"><svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
				<div id="mod-content" class="vid-mod-content resp-container">
			</div>
		</div>
	</body>
</html>